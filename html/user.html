<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Profile | Gadget Nepal</title>
  <link rel="stylesheet" href="style.css" />
  <script type="module" src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js"></script>
</head>

<body>
  <div class="container">
    <h1>User Profile</h1>
    <div class="profile">
      <img id="profileImage" src="default.jpg" alt="Profile Image" class="profile-image" />
      <input type="file" id="imageUpload" accept="image/*" />
      <p><strong>Name:</strong> <span id="userName"></span></p>
      <input type="text" id="nameInput" placeholder="Change Name" />
      <p><strong>Email:</strong> <span id="userEmail"></span></p>
      <input type="email" id="emailInput" placeholder="Change Email" />
      <input type="password" id="passwordInput" placeholder="New Password" />
      <span id="passwordStrength"></span>
      <button id="updateBtn">Update Info</button>
      <button id="logoutBtn">Logout</button>
      <button id="deleteBtn">Delete Account</button>
    </div>

    <div class="history">
      <h2>Order History</h2>
      <ul id="orderList"></ul>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <p>Are you sure you want to delete your account?</p>
      <button id="confirmYes">Yes</button>
      <button id="confirmNo">No</button>
    </div>
  </div>

  <div id="messageBox"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, updateEmail, updatePassword, deleteUser, signOut } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import { getDatabase, ref, get, set, update, remove } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

    const firebaseConfig = {

      apiKey: "AIzaSyBNCTc5RIZoPWM10DbrQLT8u9npPoNDyWM",
      authDomain: "gadget-nepal-2f95b.firebaseapp.com",
      projectId: "gadget-nepal-2f95b",
      storageBucket: "gadget-nepal-2f95b.firebasestorage.app",
      messagingSenderId: "467012972292",
      appId: "1:467012972292:web:ca9ec2130c23b2ee56aa51",
      measurementId: "G-ZRX261G3CT"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const userName = document.getElementById("userName");
    const userEmail = document.getElementById("userEmail");
    const profileImage = document.getElementById("profileImage");
    const nameInput = document.getElementById("nameInput");
    const emailInput = document.getElementById("emailInput");
    const passwordInput = document.getElementById("passwordInput");
    const passwordStrength = document.getElementById("passwordStrength");
    const updateBtn = document.getElementById("updateBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const confirmModal = document.getElementById("confirmModal");
    const confirmYes = document.getElementById("confirmYes");
    const confirmNo = document.getElementById("confirmNo");
    const imageUpload = document.getElementById("imageUpload");
    const messageBox = document.getElementById("messageBox");
    const orderList = document.getElementById("orderList");

    let currentUser;

    function showMessage(msg, type = "info") {
      messageBox.innerText = msg;
      messageBox.className = `message ${type}`;
      messageBox.style.display = "block";
      setTimeout(() => {
        messageBox.style.display = "none";
      }, 3000);
    }

    function checkPasswordStrength(password) {
      const strength = password.length >= 8 && /[A-Z]/.test(password) &&
        /[a-z]/.test(password) && /[0-9]/.test(password) &&
        /[\W_]/.test(password);
      passwordStrength.textContent = strength ? "Strong password" : "Weak password";
      passwordStrength.style.color = strength ? "green" : "red";
      return strength;
    }

    passwordInput.addEventListener("input", () => {
      checkPasswordStrength(passwordInput.value);
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        const uid = user.uid;
        userEmail.textContent = user.email;

        const userRef = ref(db, `users/${uid}`);
        get(userRef).then((snapshot) => {
          if (snapshot.exists()) {
            const data = snapshot.val();
            userName.textContent = data.name || "No name";
            profileImage.src = data.profileImage || "default.jpg";
          }
        });

        const ordersRef = ref(db, `orders/${uid}`);
        get(ordersRef).then((snapshot) => {
          if (snapshot.exists()) {
            const orders = snapshot.val();
            orderList.innerHTML = "";
            Object.values(orders).forEach(order => {
              const li = document.createElement("li");
              li.textContent = `Order ID: ${order.id}, Date: ${new Date(order.timestamp || Date.now()).toLocaleString()}`;
              orderList.appendChild(li);
            });
          } else {
            orderList.innerHTML = "<li>No order history found.</li>";
          }
        });
      } else {
        window.location.href = "auth.html";
      }
    });

    updateBtn.onclick = () => {
      const newName = nameInput.value.trim();
      const newEmail = emailInput.value.trim();
      const newPassword = passwordInput.value.trim();
      const uid = currentUser.uid;

      if (newName) {
        update(ref(db, `users/${uid}`), { name: newName });
        userName.textContent = newName;
      }

      if (newEmail && newEmail !== currentUser.email) {
        updateEmail(currentUser, newEmail)
          .then(() => {
            userEmail.textContent = newEmail;
            update(ref(db, `users/${uid}`), { email: newEmail });
            showMessage("Email updated!", "success");
          })
          .catch(error => showMessage(error.message, "error"));
      }

      if (newPassword) {
        if (!checkPasswordStrength(newPassword)) return showMessage("Password too weak!", "error");

        updatePassword(currentUser, newPassword)
          .then(() => showMessage("Password updated!", "success"))
          .catch(error => showMessage(error.message, "error"));
      }

      showMessage("Profile updated!", "success");
    };

    logoutBtn.onclick = () => {
      signOut(auth).then(() => {
        window.location.href = "auth.html";
      });
    };

    deleteBtn.onclick = () => {
      confirmModal.style.display = "block";
    };

    confirmNo.onclick = () => {
      confirmModal.style.display = "none";
    };

    confirmYes.onclick = () => {
      if (!currentUser) return;

      const uid = currentUser.uid;

      remove(ref(db, `users/${uid}`));
      remove(ref(db, `orders/${uid}`));

      deleteUser(currentUser).then(() => {
        showMessage("Account deleted.", "success");
        confirmModal.style.display = "none";
        setTimeout(() => {
          window.location.href = "auth.html";
        }, 3000);
      }).catch((error) => {
        showMessage(error.message, "error");
        confirmModal.style.display = "none";
      });
    };

    imageUpload.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        const imageUrl = reader.result;
        profileImage.src = imageUrl;
        update(ref(db, `users/${currentUser.uid}`), {
          profileImage: imageUrl
        });
        showMessage("Profile image updated", "success");
      };
      reader.readAsDataURL(file);
    });
  </script>
</body>

</html>